#!/usr/bin/env perl
#****************************************************************************
#*   autoban - dependency-generator.pl                                      *
#*   Dependancy list generator for autoban                                  *
#*                                                                          *
#*   Copyright (C) 2015 by Jeremy Falling except where noted.               *
#*                                                                          *
#*   This program is free software: you can redistribute it and/or modify   *
#*   it under the terms of the GNU General Public License as published by   *
#*   the Free Software Foundation, either version 3 of the License, or      *
#*   (at your option) any later version.                                    *
#*                                                                          *
#*   This program is distributed in the hope that it will be useful,        *
#*   but WITHOUT ANY WARRANTY; without even the implied warranty of         *
#*   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the          *
#*   GNU General Public License for more details.                           *
#*                                                                          *
#*   You should have received a copy of the GNU General Public License      *
#*   along with this program.  If not, see <http://www.gnu.org/licenses/>.  *
#****************************************************************************

#This is heavily based on scan_prereqs (in Perl::PrereqScanner) by Jerome Quelin
#http://search.cpan.org/dist/Perl-PrereqScanner/

use warnings;
use strict;
use Cwd;
use File::Find;
use File::Spec::Functions qw{ catdir updir };
use FindBin qw{ $Bin };

use List::Util qw{ max };
use Perl::PrereqScanner;

my $pwd = getcwd;

#ensure we are only run from the build dir
if ( $pwd !~ 'autoban/build' ) {
    print "ERROR: you must run this from the autoban build directory!\n\n";
    exit 1;
}

my $depsFile = '../dependencies.txt';
open( my $fh, '>', $depsFile ) or die "Could not open file '$depsFile' $!";
printf $fh ( "#dependency list generated by dependency-generator.pl on " . gmtime() . "\n" );
printf $fh ("#use with cpanm, such as 'cpanm < dependencies.txt' \n");

print "Building deps list at $depsFile\n";

eval 'exec /usr/bin/perl  -S $0 ${1+"$@"}'
  if 0;    # not running under some shell

my $combined = CPAN::Meta::Requirements->new;

foreach my $file ( @ARGV ? @ARGV : '../' ) {
    -d $file ? scan_dir($file) : scan_file($file);
}

sub scan_dir {
    find(
        {
            no_chdir => 1,
            wanted   => sub { scan_file($_) if /\.(pl|pm|psgi|t)$/ && -f $_; }
        },
        shift
    );
}

sub scan_file {
    my $file = shift;
    return if ( $file =~ 'build' );    # exclude the build dir
    my $prereqs = Perl::PrereqScanner->new->scan_file($file);
    $combined->add_requirements($prereqs);
}

print_prereqs($combined);

#generate a list that can be use with cpanm
sub print_prereqs {
    my $prereqs = shift->as_string_hash;
    my $max = max map { length } keys %$prereqs;

    for ( sort keys %$prereqs ) {
        my $curentMod = "$_";

        #exclude autoban modules and some standard perl mods
        unless ( "$_" =~ 'autoban|feature|if|lib|strict|warning|Fcntl' ) {
            printf $fh ( "%s~%s\n", $curentMod, $prereqs->{$curentMod} );
        }
    }
}

print "Done\n";

exit;

